# USRP Player для B210 (SignalSim)

Небольшая утилита на UHD, которая читает файл с IQ‑отсчётами и непрерывно передаёт их через USRP B210 (подойдёт и другая B2xx). Поддерживаются 8‑битные (`--8bit`) и 16‑битные файлы; данные конвертируются в `fc32` и стримятся через UHD.

## Состав репозитория
- `usrp_player.cpp` — основной исходник плеера.
- `makefile` — устаревший Makefile под другой пример (`uhd_sc8_tx_streaming.cpp` отсутствует); для этого проекта собирайте командой из раздела «Сборка».
- `usrp_b200_fw.hex`, `usrp_b200_bl.img` — штатные прошивки B200/B210 (для пере-прошивки через UHD при необходимости).
- `LibreSDR_USRP/` — патчённый образ FPGA (`libresdr_b210.bin`), скрипты для замены штатного `usrp_b210_fpga.bin`, а также архив с исходниками/бинарником старой версии плеера.

## Требования
- UHD (рекомендовано 4.8.x) с загруженными образами `uhd_images_downloader`.
- Boost: `program_options`, `thread`, `system`.
- GCC/Clang с поддержкой C++14.
- Аппаратно: USB 3.0, B210 (или другая B2xx), стабильное питание; для скоростей >30 MS/s — производительный CPU/SSD.

Установка зависимостей (Ubuntu/Debian):
```bash
sudo apt update
sudo apt install libuhd-dev uhd-host libboost-program-options-dev \
                 libboost-thread-dev libboost-system-dev build-essential
sudo uhd_images_downloader   # загрузить образы FPGA/firmware
```

## Сборка
```bash
g++ -std=c++14 -O3 -march=native \
    usrp_player.cpp -o usrp_player \
    -luhd -lboost_program_options -lboost_system -lboost_thread -pthread
```
При нестандартном пути к UHD добавьте `-I/usr/local/include -L/usr/local/lib -Wl,-rpath,/usr/local/lib`.

## Запуск
Минимальный вызов (8‑битный файл, параметры обязательны):
```bash
./usrp_player --file signal.C8 --8bit --freq 1575.42e6 --rate 5e6 --gain 35
```
Пример для 16‑битного файла:
```bash
./usrp_player --file if16.iq --rate 2e6 --freq 433e6 --gain 20 --spb 4000
```

Ключевые параметры:
- `--file` (обязательный) — путь к файлу с IQ.
- `--8bit` — входной файл в SC8 (I/Q по 1 байту). Для него **обязательны** `--rate` и `--freq`.
- `--rate` — частота дискретизации, Гц.
- `--freq` — центральная частота, Гц.
- `--gain` — TX усиление, dB (по умолчанию 20).
- `--spb` — сэмплов на буфер (по умолчанию 10000; при превышении аппаратного лимита программа уменьшит значение).
- `--args` — строка UHD (`type=b200`, `addr=…`, `num_send_frames=…`, и т.п.).
- `--wirefmt` — `sc16` (по умолчанию) или `sc8`. При скоростях ≥46 MS/s код автоматически переключает часть параметров на SC8 и увеличенные буферы.
- `--shift` — сдвиг амплитуды вправо на 0–4 бита для 8‑/16‑битных файлов.

Поведение:
- Файл читается по кругу; при достижении конца автоматически возвращается в начало.
- Выводит статистику каждые 5 с.
- Корректное завершение — `Ctrl+C` (SIGINT).

## Советы для высоких скоростей (>30 MS/s)
- Используйте USB 3.0 без хабов; короткий качественный кабель.
- При `rate >= 46e6` программа добавит в `--args` параметры `recv_frame_size`, `num_recv_frames/num_send_frames`, `master_clock_rate=46.5e6`.
- Можно вручную задать `--wirefmt sc8` для снижения нагрузки на шину.
- Установите приоритет потока: `sudo chrt -f 50 ./usrp_player ...`.

## LibreSDR патч (необязательно, на ваш риск)
В `LibreSDR_USRP/patch_exact.sh` есть скрипт, который **заменяет** штатный `usrp_b210_fpga.bin` на модифицированный `libresdr_b210.bin`. Скрипт делает резервную копию (`usrp_b210_fpga.bin.backup`), но требует `sudo`. Используйте только если понимаете, зачем это нужно; после замены перезапустите `uhd_images_downloader` для отката.

## Дополнительно
- В `LibreSDR_USRP/usrp_player.tar` лежит архив со старой версией плеера `uhd_sc8_tx_streaming.cpp` и README — можно извлечь для сравнения или отладки.
- `makefile` в корне рассчитан именно на тот пример из архива; для текущего `usrp_player.cpp` используйте прямую команду компиляции выше.
